networks:
  str_simulation_net:
    name: str_sentinel_net
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24

services:
  # Hikvision Camera (HTTP) - Realistic headers that Recog understands
  camera:
    image: nginx:alpine
    container_name: str_camera_hikvision
    mac_address: "00:40:8C:11:22:33"  # 00:40:8C = real Hikvision OUI
    networks:
      str_simulation_net:
        ipv4_address: 172.20.0.10
    ports:
      - "8081:80"
    command: /bin/sh -c "echo 'server { listen 80; server_tokens off; location / { root /usr/share/nginx/html; index index.html; add_header Server \"Hikvision-Webs\" always; add_header WWW-Authenticate \"Basic realm=Hikvision DS-2CD2042WD\" always; } }' > /etc/nginx/conf.d/default.conf && echo '<html><head><title>Hikvision DS-2CD2042WD-I Network Camera</title></head><body><h1>Network Camera</h1><p>Please log in to access device</p></body></html>' > /usr/share/nginx/html/index.html && nginx -g 'daemon off;'"

  # Smart Lock (SSH)
  smart_lock:
    platform: linux/amd64
    image: rastasheep/ubuntu-sshd
    container_name: str_lock_yale
    mac_address: "00:17:7A:AA:BB:CC"  # 00:17:7A = real Yale/Assa Abloy OUI
    networks:
      str_simulation_net:
        ipv4_address: 172.20.0.20
    environment:
      - USER_PASSWORD=root
    ports:
      - "2222:22"

  # Smart Thermostat (mDNS)
  thermostat:
    image: flungo/avahi
    container_name: str_nest_mdns
    mac_address: "18:B4:30:12:34:56"  # 18:B4:30 = official Nest Labs OUI
    networks:
      str_simulation_net:
        ipv4_address: 172.20.0.35
    volumes:
      - ./nest.service:/etc/avahi/services/nest.service:ro
    environment:
      - REFLECTOR_ENABLE_REFLECTOR=yes

  # THE SENTINEL APP (The Scanner Container)
  sentinel:
    build: ../app        # Tells Docker to look in the app/ folder for the Dockerfile
    container_name: str_sentinel_app
    command: tail -f /dev/null  # Keeps container running for interactive use
    networks:
      str_simulation_net:
        ipv4_address: 172.20.0.50
    volumes:
      - ../app:/app      # Syncs code so I can edit main.py without rebuilding
    cap_add:
      - NET_ADMIN        # Essential for scanner to "sniff" the network
    depends_on:
      - camera
      - smart_lock
      - thermostat